<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é¼»é¼»é¤Šæˆé—–é—œï½œç¬¬ 1 é—œï¼ˆéŠæˆ²ç‰ˆ Demoï¼‰</title>
  <style>
    :root{
      --bg1:#2b1b14;
      --bg2:#7a4b2b;
      --panel:#f4e2c8;     /* ç±³è‰²é¢æ¿ */
      --panel2:#f0d6b0;
      --ink:#1a1412;
      --muted:#5b4b42;
      --accent:#ffb23f;   /* äº®æ©˜ */
      --accent2:#ff7a59;  /* çŠç‘š */
      --good:#1b7f4b;
      --bad:#b45309;
      --shadow: 0 18px 45px rgba(0,0,0,.25);
      --round:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial,sans-serif;
      color:var(--ink);
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 70% -10%, rgba(255,178,63,.25), transparent 65%),
        radial-gradient(900px 500px at 10% 110%, rgba(255,122,89,.20), transparent 60%),
        linear-gradient(155deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 92px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:#fff;margin-bottom:12px
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900;letter-spacing:.4px
    }
    .brand .tag{font-size:12px;opacity:.9;background:rgba(255,255,255,.14);padding:6px 10px;border-radius:999px}
    .btnTiny{
      border:1px solid rgba(255,255,255,.22);
      color:#fff;background:rgba(0,0,0,.12);
      padding:8px 10px;border-radius:14px;cursor:pointer;
      font-weight:800;font-size:13px
    }
    .grid{
      display:grid;gap:12px;
      grid-template-columns: 320px 1fr;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius:var(--round);
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.35);
      overflow:hidden;
    }
    .cardPad{padding:14px}
    .hdrRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{
      font-size:12px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      background:rgba(0,0,0,.08);
      color:var(--ink)
    }

    /* å·¦å´ï¼šé¼»é¼»é¢æ¿ */
    .charStage{
      padding:14px;
      background:
        radial-gradient(650px 240px at 50% 10%, rgba(255,255,255,.50), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.15), rgba(0,0,0,.06));
      position:relative;
      min-height:520px;
    }
    .dayBadge{
      position:absolute;top:12px;right:12px;
      background:rgba(0,0,0,.12);
      color:var(--ink);
      padding:8px 12px;border-radius:14px;font-weight:1000
    }
    .stats{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .statBox{
      background:rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.05);
      border-radius:16px;
      padding:10px 10px;
    }
    .statName{font-size:12px;color:var(--muted);font-weight:900}
    .statVal{font-size:16px;font-weight:1000;margin-top:4px}
    .bar{
      height:10px;border-radius:999px;background:rgba(0,0,0,.12);overflow:hidden;margin-top:8px
    }
    .bar > div{height:100%;width:40%;background:linear-gradient(90deg, var(--accent), var(--accent2));border-radius:999px}

    .bibi{
      margin:12px auto 0;
      width:210px;height:210px;border-radius:26px;
      background:
        radial-gradient(120px 120px at 40% 35%, rgba(255,255,255,.95), rgba(255,255,255,.35) 60%, rgba(0,0,0,.05) 100%),
        linear-gradient(145deg, rgba(255,255,255,.55), rgba(0,0,0,.08));
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 18px 35px rgba(0,0,0,.18);
      position:relative;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .bibi::before{
      content:"BI-BI";
      font-weight:1000;
      letter-spacing:1px;
      color:rgba(0,0,0,.25);
      font-size:18px;
    }
    .bibiMood{
      position:absolute;bottom:10px;right:10px;
      font-size:22px;
      background:rgba(255,255,255,.7);
      border:1px solid rgba(0,0,0,.08);
      padding:6px 10px;border-radius:999px;
    }

    .bubble{
      margin:12px auto 0;
      width:100%;
      background:rgba(255,255,255,.70);
      border:1px solid rgba(0,0,0,.07);
      border-radius:18px;
      padding:12px 12px;
      position:relative;
    }
    .bubble::after{
      content:"";
      position:absolute;
      left:38px; top:-8px;
      width:16px; height:16px;
      background:rgba(255,255,255,.70);
      border-left:1px solid rgba(0,0,0,.07);
      border-top:1px solid rgba(0,0,0,.07);
      transform:rotate(45deg);
    }
    .bubbleTitle{font-weight:1000;margin-bottom:6px}
    .bubbleText{font-size:14px;line-height:1.5;color:var(--ink)}
    .bubbleBtns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .btn{
      border:0;cursor:pointer;
      padding:10px 12px;border-radius:14px;font-weight:1000;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      color:#2b1b14;
      box-shadow:0 14px 25px rgba(255,178,63,.25);
    }
    .btnGhost{
      border:1px solid rgba(0,0,0,.14);
      background:rgba(255,255,255,.55);
      color:var(--ink);
      padding:10px 12px;border-radius:14px;font-weight:1000;
      cursor:pointer;
    }
    .btn:disabled,.btnGhost:disabled{opacity:.55;cursor:not-allowed}

    /* å³å´ï¼šä»»å‹™å€ */
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:12px 14px;
      background:rgba(0,0,0,.08);
      border-bottom:1px solid rgba(255,255,255,.18);
    }
    .tab{
      padding:8px 12px;border-radius:14px;
      font-weight:1000;font-size:13px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.35);
      cursor:pointer;
    }
    .tab.active{
      background:rgba(255,255,255,.72);
      border-color:rgba(0,0,0,.18);
    }
    .pane{display:none}
    .pane.active{display:block}
    .sectionTitle{font-weight:1000;margin:0 0 6px}
    .sub{font-size:12px;color:var(--muted);line-height:1.45;margin:0}
    .task{
      background:rgba(255,255,255,.58);
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px;
      padding:12px;
      margin:12px 0;
    }
    .taskHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .badge{
      font-size:12px;font-weight:1000;
      padding:6px 10px;border-radius:999px;
      background:rgba(0,0,0,.08);
    }
    .taskLock{opacity:.55}
    .q{
      margin-top:10px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.60);
    }
    .qtitle{font-weight:1000;margin-bottom:8px}
    label{display:block;margin:6px 0;font-size:14px}
    .resultLine{margin-top:10px;font-weight:1000}
    .ok{color:var(--good)}
    .warn{color:var(--bad)}
    .input{
      width:100%;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(0,0,0,.18);
      background:rgba(255,255,255,.65);
      outline:none;font-size:14px
    }
    .board{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      overflow:hidden;
      border-radius:16px;
    }
    .board th,.board td{
      padding:10px 8px;
      border-bottom:1px solid rgba(0,0,0,.06);
      text-align:left;
      vertical-align:top;
    }
    .board th{background:rgba(255,255,255,.55);font-weight:1000}
    .boardWrap{
      background:rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px;
      overflow:hidden;
      margin-top:12px;
    }
    .toast{
      position:fixed;left:50%;bottom:80px;transform:translateX(-50%);
      background:rgba(20,16,14,.92);
      color:#fff;padding:10px 12px;border-radius:14px;
      font-size:13px;font-weight:900;
      opacity:0;pointer-events:none;
      transition:opacity .18s ease;
      max-width:min(560px, calc(100% - 24px));
    }
    .toast.show{opacity:1}
    .footerBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(20,16,14,.85);
      backdrop-filter: blur(8px);
      border-top:1px solid rgba(255,255,255,.12);
      color:#fff;
      padding:10px 12px;
    }
    .footerInner{
      max-width:980px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .footerPill{
      background:rgba(255,255,255,.12);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div style="font-size:18px">é¼»é¼»é¤Šæˆé—–é—œ</div>
        <div class="tag">éŠæˆ²ç‰ˆ Demoï½œDay 1</div>
      </div>
      <div class="row">
        <button class="btnTiny" id="btnSetNick">è¨­å®šæš±ç¨±</button>
        <button class="btnTiny" id="btnSeed">åŠ å…¥ 3 ä½åŒå„•ï¼ˆDemoï¼‰</button>
        <button class="btnTiny" id="btnReset">æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Character & Stats -->
      <div class="card">
        <div class="charStage">
          <div class="dayBadge" id="dayBadge">Day 1</div>

          <div class="hdrRow">
            <div class="pill">é¼»é¼»ç‹€æ…‹é¢æ¿</div>
            <div class="pill" id="unlockPill">æœªè§£é–</div>
          </div>

          <div class="stats">
            <div class="statBox">
              <div class="statName">å¥åº·å€¼ï¼ˆHPï¼‰</div>
              <div class="statVal" id="hpText">72</div>
              <div class="bar"><div id="hpBar"></div></div>
            </div>
            <div class="statBox">
              <div class="statName">è¦ªå¯†åº¦ï¼ˆLvï¼‰</div>
              <div class="statVal" id="lvText">Lv.1</div>
              <div class="bar"><div id="lvBar"></div></div>
            </div>
            <div class="statBox">
              <div class="statName">EXP</div>
              <div class="statVal"><span id="expText">0</span></div>
              <div class="bar"><div id="expBar"></div></div>
            </div>
            <div class="statBox">
              <div class="statName">é€£çºŒå¤©æ•¸ï¼ˆStreakï¼‰</div>
              <div class="statVal" id="streakText">0</div>
              <div class="bar"><div id="streakBar"></div></div>
            </div>
          </div>

          <div class="bibi" id="bibi">
            <div class="bibiMood" id="mood">ğŸ˜£</div>
          </div>

          <div class="bubble" id="bubble">
            <div class="bubbleTitle">é¼»é¼»</div>
            <div class="bubbleText" id="bubbleText"></div>
            <div class="bubbleBtns">
              <button class="btn" id="btnContinue">ç¹¼çºŒ</button>
              <button class="btnGhost" id="btnSkip">è·³éå°è©±</button>
            </div>
          </div>

          <div class="cardPad" style="padding-top:10px">
            <div class="sub">æš±ç¨±ï¼ˆåŒ¿åï¼‰ï¼š<b id="nickText">æœªè¨­å®š</b></div>
            <div class="sub">User IDï¼š<span id="uidText"></span></div>
            <div class="sub">æç¤ºï¼šé»ä¸€ä¸‹é¼»é¼»ï¼Œå¯ä»¥è½åˆ°ä¸åŒçš„é¼“å‹µèªï¼ˆæ–‡å­—ï¼‰ã€‚</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Tasks & Leaderboard -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" data-tab="tasks">ğŸ§© ä»Šæ—¥ä»»å‹™</button>
          <button class="tab" data-tab="quiz">ğŸ“ å°æ¸¬é©—</button>
          <button class="tab" data-tab="leader">ğŸ† æ’è¡Œæ¦œ</button>
        </div>

        <div class="cardPad">

          <!-- TASKS PANE -->
          <div class="pane active" id="pane-tasks">
            <h3 class="sectionTitle">Day 1ï½œå†·æ°£æˆ¿ç”Ÿå­˜è¨“ç·´</h3>
            <p class="sub">æµç¨‹ï¼šæ•…äº‹ â†’ å½±ç‰‡ â†’ å°æ¸¬é©—é€šé â†’ æ‰“å¡ +10 EXPï¼ˆåŒæ™‚æ›´æ–°æ’è¡Œæ¦œï¼‰ã€‚</p>

            <div class="task" id="task-video">
              <div class="taskHead">
                <div>
                  <div style="font-weight:1000">ğŸ¥ ä»»å‹™ 1ï½œè§€çœ‹å½±ç‰‡</div>
                  <div class="sub">çœ‹å®Œå¾Œå†å»ã€Œå°æ¸¬é©—ã€å›ç­”å•é¡Œã€‚</div>
                </div>
                <div class="badge" id="videoBadge">æœªå®Œæˆ</div>
              </div>

              <div style="height:10px"></div>
              <input class="input" id="videoUrl" placeholder="è²¼ä¸Š YouTube é€£çµï¼ˆä¾‹ï¼šhttps://youtu.be/....ï¼‰" />
              <div style="height:10px"></div>
              <button class="btn" id="btnOpenVideo">é–‹å•Ÿå½±ç‰‡ï¼ˆæ–°åˆ†é ï¼‰</button>
            </div>

            <div class="task" id="task-checkin">
              <div class="taskHead">
                <div>
                  <div style="font-weight:1000">âœ… ä»»å‹™ 2ï½œå®Œæˆæ‰“å¡</div>
                  <div class="sub">éœ€å…ˆé€šéå°æ¸¬é©—æ‰å¯æ‰“å¡ã€‚</div>
                </div>
                <div class="badge" id="checkinBadge">æœªè§£é–</div>
              </div>

              <div style="height:10px"></div>
              <button class="btn" id="btnCheckin" disabled>æˆ‘å·²å®Œæˆç¬¬ 1 é—œï¼ˆæ‰“å¡ +10 EXPï¼‰</button>
              <div class="resultLine" id="todayLine">ä»Šæ—¥æ‰“å¡ç‹€æ…‹ï¼šå°šæœªæ‰“å¡</div>
            </div>

            <div class="task">
              <div class="taskHead">
                <div>
                  <div style="font-weight:1000">ğŸ§­ ä½ æœƒåœ¨å¾Œå°çœ‹åˆ°ä»€éº¼ï¼Ÿ</div>
                  <div class="sub">æ­¤ Demo å…ˆç”¨æœ¬æ©Ÿæ’è¡Œæ¦œï¼ˆåŒä¸€å°è£ç½®æ‰çœ‹å¾—åˆ°ï¼‰ã€‚ç¢ºå®šç©æ³•å¾Œå†æ¥é›²ç«¯å¾Œå°ã€‚</div>
                </div>
                <div class="badge">Demo</div>
              </div>
              <div class="sub" style="margin-top:10px;line-height:1.55">
                ä½ æœƒå¾—åˆ°ï¼š<b>EXP</b>ã€<b>Streak</b>ã€ä»¥åŠã€ŒåŒå„•æ’è¡Œæ¦œã€ï¼›  
                å—è©¦è€…ç«¯åªçœ‹åˆ°æš±ç¨±ï¼Œä¸çœ‹åˆ°çœŸå¯¦èº«ä»½ã€‚
              </div>
            </div>
          </div>

          <!-- QUIZ PANE -->
          <div class="pane" id="pane-quiz">
            <h3 class="sectionTitle">å°æ¸¬é©—ï¼ˆDay 1ï¼‰</h3>
            <p class="sub">é€šéæ¨™æº–ï¼šè‡³å°‘ 2/3ã€‚é€šéå¾Œè§£é–æ‰“å¡ã€‚</p>

            <form id="quizForm">
              <div class="q">
                <div class="qtitle">Q1. åœ¨å†·æ°£æˆ¿ä¸­ï¼Œç‚ºä»€éº¼é¼»å­å®¹æ˜“è¦ºå¾—ä¹¾ä¹¾ä¸èˆ’æœï¼Ÿ</div>
                <label><input type="radio" name="q1" value="A" required> A. å› ç‚ºå†·æ°£æœƒè®“ç©ºæ°£è®Šä¹¾</label>
                <label><input type="radio" name="q1" value="B"> B. å› ç‚ºå…‰ç·šå¤ªäº®</label>
                <label><input type="radio" name="q1" value="C"> C. å› ç‚ºæ¡Œæ¤…å¤ªç¡¬</label>
              </div>

              <div class="q">
                <div class="qtitle">Q2. åœ¨å†·æ°£æˆ¿è¦ºå¾—é¼»å­ä¸èˆ’æœï¼Œå“ªå€‹åšæ³•æ¯”è¼ƒé©åˆï¼Ÿ</div>
                <label><input type="radio" name="q2" value="A" required> A. ç›´æ¥è®“å†·æ°£å°è‘—è‡‰å¹</label>
                <label><input type="radio" name="q2" value="B"> B. èª¿æ•´æº«åº¦ã€æ³¨æ„ä¿æ¿•</label>
                <label><input type="radio" name="q2" value="C"> C. å–å¾ˆå¤šå†°æ°´é™ç«æ°£</label>
              </div>

              <div class="q">
                <div class="qtitle">Q3. ä¸‹åˆ—å“ªä¸€å€‹æ˜¯æ¯”è¼ƒå¥½çš„é¼»éƒ¨æ—¥å¸¸ç…§è­·æ–¹å¼ï¼Ÿ</div>
                <label><input type="radio" name="q3" value="A" required> A. ä¸€ç›´æ‰é¼»å­</label>
                <label><input type="radio" name="q3" value="B"> B. è¦å¾‹æ¸…æ½”ï¼Œå¿…è¦æ™‚å¯ç”¨ç”Ÿç†é£Ÿé¹½æ°´</label>
                <label><input type="radio" name="q3" value="C"> C. å®Œå…¨ä¸ç†å®ƒ</label>
              </div>

              <button class="btn" type="submit">é€å‡ºå°æ¸¬é©—ï¼ˆè§£é–ï¼‰</button>
            </form>

            <div class="resultLine" id="quizResultLine">æ¸¬é©—çµæœï¼šå°šæœªä½œç­”</div>
            <div class="sub" style="margin-top:6px">
              å°æç¤ºï¼šé€šéå¾Œå›åˆ°ã€Œä»Šæ—¥ä»»å‹™ã€å°±èƒ½æ‰“å¡ã€‚
            </div>
          </div>

          <!-- LEADERBOARD PANE -->
          <div class="pane" id="pane-leader">
            <h3 class="sectionTitle">æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿ Demoï¼‰</h3>
            <p class="sub">æ’åºï¼šç¸½ EXP â†“ï¼ŒStreak â†“ã€‚é»å³ä¸Šã€ŒåŠ å…¥ 3 ä½åŒå„•ã€å¯çœ‹åˆ°ç«¶çˆ­æ•ˆæœã€‚</p>

            <div class="boardWrap">
              <table class="board" id="leaderTable">
                <thead>
                  <tr>
                    <th style="width:60px">æ’å</th>
                    <th>æš±ç¨±</th>
                    <th style="width:90px">EXP</th>
                    <th style="width:90px">Streak</th>
                    <th style="width:140px">æœ€å¾Œæ´»èº</th>
                  </tr>
                </thead>
                <tbody id="leaderBody"></tbody>
              </table>
            </div>

            <div class="task" style="margin-top:12px">
              <div style="font-weight:1000">ç®¡ç†è€…æ¸¬è©¦å»ºè­°</div>
              <div class="sub" style="margin-top:6px;line-height:1.55">
                1) å…ˆç”¨ Demo æ’è¡Œæ¦œç¢ºå®šã€Œæˆå°±/çå‹µã€å°é’å°‘å¹´æœ‰å¸å¼•åŠ›ã€‚<br/>
                2) ç­‰ä»‹é¢èˆ‡é—œå¡å®šç¨¿å¾Œï¼Œå†æŠŠäº‹ä»¶ç´€éŒ„æ”¹æ¥ Google Sheetï¼ˆé›²ç«¯å¾Œå°ï¼‰ã€‚<br/>
                3) æ’è¡Œæ¦œåªé¡¯ç¤ºæš±ç¨±ï¼Œé¿å…å€‹è³‡é¢¨éšªã€‚
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">å·²å®Œæˆ</div>

  <div class="footerBar">
    <div class="footerInner">
      <div class="footerPill">Day 1ï½œå†·æ°£æˆ¿ç”Ÿå­˜è¨“ç·´</div>
      <div class="footerPill">ç‹€æ…‹ï¼š<span id="footerStatus">æœªè§£é–</span></div>
      <div class="footerPill">æç¤ºï¼šå…ˆå®Œæˆã€Œå°æ¸¬é©—ã€å†æ‰“å¡</div>
    </div>
  </div>

<script>
  // ===== æœ¬æ©Ÿè³‡æ–™ï¼ˆDemo ç”¨ï¼‰=====
  const DB_KEY = "bibi_game_demo_events_v1";
  const STATE_KEY = "bibi_game_demo_state_v1";
  const todayKey = () => new Date().toISOString().slice(0,10);

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1200);
  }

  function dbLoad(){ try { return JSON.parse(localStorage.getItem(DB_KEY) || "[]"); } catch(e){ return []; } }
  function dbSave(rows){ localStorage.setItem(DB_KEY, JSON.stringify(rows)); }
  function stateLoad(){ try { return JSON.parse(localStorage.getItem(STATE_KEY) || "{}"); } catch(e){ return {}; } }
  function stateSave(s){ localStorage.setItem(STATE_KEY, JSON.stringify(s)); }

  function getOrCreateUserId(){
    const k = "bibi_user_id";
    let id = localStorage.getItem(k);
    if(!id){
      id = "U" + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
      localStorage.setItem(k, id);
    }
    return id;
  }
  function getNickname(){ return (localStorage.getItem("bibi_nickname") || "").trim(); }
  function setNickname(n){ localStorage.setItem("bibi_nickname", (n||"").trim()); }

  function logEvent(event, extra){
    const row = {
      ts: new Date().toISOString(),
      user_id: getOrCreateUserId(),
      nickname: getNickname(),
      level: 1,
      event,
      ...extra
    };
    const rows = dbLoad();
    rows.push(row);
    dbSave(rows);
  }

  // ===== Story (Day 1) =====
  const story = [
    "å°ä¸»äººâ€¦â€¦ä½ ä¾†äº†å—ï¼Ÿ",
    "ä»Šå¤©æ•™å®¤å†·æ°£é–‹å¥½å¼·ï¼Œæˆ‘çš„é¼»å­è£¡é¢å¥½ä¹¾ã€å¥½ç™¢ï¼Œé‚„ä¸€ç›´æƒ³æ‰“å™´åšâ€¦â€¦",
    "æˆ‘çœŸçš„æœ‰é»æ’ä¸ä½äº†ã€‚ä½ å¯ä»¥é™ªæˆ‘å®Œæˆä»Šå¤©çš„ä»»å‹™ï¼Œå¹«æˆ‘è®Šå¾—èˆ’æœä¸€é»å—ï¼Ÿ",
    "å…ˆçœ‹ä¸€æ®µçŸ­å½±ç‰‡ï¼Œç„¶å¾Œå»å°æ¸¬é©—å›ç­”å•é¡Œã€‚é€šéå¾Œå°±èƒ½æ‰“å¡ï¼ŒåŠ  EXPï¼"
  ];
  let storyIdx = 0;

  function setBubble(text){
    document.getElementById("bubbleText").textContent = text;
  }

  function setUnlocked(unlocked){
    const pill = document.getElementById("unlockPill");
    const footer = document.getElementById("footerStatus");
    if(unlocked){
      pill.textContent = "å·²è§£é–";
      pill.style.background = "rgba(27,127,75,.18)";
      footer.textContent = "å·²è§£é–";
      document.getElementById("mood").textContent = "ğŸ˜Š";
      document.getElementById("checkinBadge").textContent = "å¯æ‰“å¡";
    }else{
      pill.textContent = "æœªè§£é–";
      pill.style.background = "rgba(0,0,0,.08)";
      footer.textContent = "æœªè§£é–";
      document.getElementById("mood").textContent = "ğŸ˜£";
      document.getElementById("checkinBadge").textContent = "æœªè§£é–";
    }
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  function renderBars(exp, streak, hp, lv){
    document.getElementById("expBar").style.width = clamp(exp,0,100) + "%";
    document.getElementById("streakBar").style.width = clamp(streak*10,0,100) + "%";
    document.getElementById("hpBar").style.width = clamp(hp,0,100) + "%";
    document.getElementById("lvBar").style.width = clamp(lv*25,0,100) + "%";
  }

  function render(){
    const s = stateLoad();
    const uid = getOrCreateUserId();
    const nick = getNickname();

    document.getElementById("uidText").textContent = uid;
    document.getElementById("nickText").textContent = nick || "æœªè¨­å®š";

    // defaults
    if(s.hp === undefined) s.hp = 72;
    if(s.lv === undefined) s.lv = 1;
    if(s.exp === undefined) s.exp = 0;
    if(s.streak === undefined) s.streak = 0;

    // video status
    document.getElementById("videoBadge").textContent = s.videoOpened ? "å·²é–‹å•Ÿ" : "æœªå®Œæˆ";

    // unlock status
    setUnlocked(!!s.unlocked);

    // checkin button
    const checkedToday = (s.lastCheckin === todayKey());
    const btnCheckin = document.getElementById("btnCheckin");
    btnCheckin.disabled = (!s.unlocked) || checkedToday;
    document.getElementById("todayLine").textContent = "ä»Šæ—¥æ‰“å¡ç‹€æ…‹ï¼š" + (checkedToday ? "âœ… å·²æ‰“å¡" : "å°šæœªæ‰“å¡");

    // stats
    document.getElementById("hpText").textContent = String(s.hp);
    document.getElementById("lvText").textContent = "Lv." + String(s.lv);
    document.getElementById("expText").textContent = String(s.exp);
    document.getElementById("streakText").textContent = String(s.streak);
    renderBars(s.exp, s.streak, s.hp, s.lv);

    // quiz result
    document.getElementById("quizResultLine").textContent = "æ¸¬é©—çµæœï¼š" + (s.quizText || "å°šæœªä½œç­”");

    stateSave(s);
    renderLeaderboard();
  }

  function renderLeaderboard(){
    const rows = dbLoad();
    // build participants summary
    const m = new Map();
    for(const r of rows){
      if(!r.user_id) continue;
      if(!m.has(r.user_id)){
        m.set(r.user_id, { user_id:r.user_id, nickname:r.nickname||"", total_exp:0, streak:0, last_seen:r.ts });
      }
      const p = m.get(r.user_id);
      if(r.nickname) p.nickname = r.nickname;
      if(r.ts && (!p.last_seen || r.ts > p.last_seen)) p.last_seen = r.ts;
      if(r.event === "checkin"){
        const te = Number(r.total_exp||0);
        if(Number.isFinite(te)) p.total_exp = Math.max(p.total_exp, te);
        const st = Number(r.streak||0);
        if(Number.isFinite(st)) p.streak = Math.max(p.streak, st);
      }
    }
    const list = Array.from(m.values()).sort((a,b)=>{
      if(b.total_exp !== a.total_exp) return b.total_exp - a.total_exp;
      return b.streak - a.streak;
    });

    const tb = document.getElementById("leaderBody");
    tb.innerHTML = "";
    const fmt = (ts)=>{ try { return new Date(ts).toLocaleString(); } catch(e){ return ts||""; } };

    if(list.length === 0){
      tb.innerHTML = `<tr><td colspan="5" style="padding:14px"><span style="color:rgba(0,0,0,.55);font-weight:900">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚å…ˆå®Œæˆå°æ¸¬é©—ä¸¦æ‰“å¡ï¼Œæˆ–æŒ‰ã€ŒåŠ å…¥ 3 ä½åŒå„•ã€çœ‹æ•ˆæœã€‚</span></td></tr>`;
      return;
    }

    list.forEach((p, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${p.nickname || "<span style='color:rgba(0,0,0,.55);font-weight:900'>æœªè¨­å®š</span>"}</td>
        <td>${p.total_exp}</td>
        <td>${p.streak}</td>
        <td><span style="color:rgba(0,0,0,.62)">${fmt(p.last_seen)}</span></td>
      `;
      tb.appendChild(tr);
    });
  }

  // ===== Tabs =====
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.dataset.tab;
      document.querySelectorAll(".pane").forEach(p=>p.classList.remove("active"));
      document.getElementById("pane-" + target).classList.add("active");
    });
  });

  // ===== Story controls =====
  function startStory(){
    const s = stateLoad();
    if(s.storyDone){
      setBubble("ä»Šå¤©æˆ‘å€‘å°±ç…§é€™å€‹æµç¨‹ï¼šå½±ç‰‡ â†’ å°æ¸¬é©— â†’ æ‰“å¡ã€‚ä½ åšå¾—åˆ°ã€‚");
      document.getElementById("btnContinue").disabled = true;
      return;
    }
    storyIdx = 0;
    setBubble(story[0]);
  }

  document.getElementById("btnContinue").addEventListener("click", ()=>{
    const s = stateLoad();
    storyIdx += 1;
    if(storyIdx >= story.length){
      s.storyDone = true;
      stateSave(s);
      setBubble("ä»»å‹™å·²é–‹å•Ÿï¼å…ˆçœ‹å½±ç‰‡ï¼Œå†å»å°æ¸¬é©—ã€‚å®Œæˆå¾Œå›ä¾†æ‰“å¡ã€‚");
      document.getElementById("btnContinue").disabled = true;
      toast("ä»»å‹™é–‹å•Ÿ");
      return;
    }
    setBubble(story[storyIdx]);
  });

  document.getElementById("btnSkip").addEventListener("click", ()=>{
    const s = stateLoad();
    s.storyDone = true;
    stateSave(s);
    setBubble("ä»»å‹™å·²é–‹å•Ÿï¼å…ˆçœ‹å½±ç‰‡ï¼Œå†å»å°æ¸¬é©—ã€‚å®Œæˆå¾Œå›ä¾†æ‰“å¡ã€‚");
    document.getElementById("btnContinue").disabled = true;
    toast("å·²è·³éå°è©±");
  });

  // Click bibi for random encouragement
  const cheers = [
    "æˆ‘æœ‰é»ä¹¾ä¹¾çš„â€¦â€¦ä½ å¯ä»¥å¹«æˆ‘å—ï¼Ÿ",
    "å¦‚æœä½ å®Œæˆä»»å‹™ï¼Œæˆ‘æœƒè®Šå¾—æ›´èˆ’æœï¼",
    "ä½ åšå¾—åˆ°ï¼Œæˆ‘ç›¸ä¿¡ä½ ã€‚",
    "å†·æ°£æˆ¿çœŸçš„å¾ˆå®¹æ˜“è®“æˆ‘é¼»å­ä¸èˆ’æœã€‚"
  ];
  document.getElementById("bibi").addEventListener("click", ()=>{
    setBubble(cheers[Math.floor(Math.random()*cheers.length)]);
    toast("é¼»é¼»ï¼šæ”¶åˆ°");
  });

  // ===== Nickname =====
  function promptNick(){
    const cur = getNickname();
    const nick = prompt("è«‹è¼¸å…¥åŒ¿åæš±ç¨±ï¼ˆä¾‹ï¼šA01ã€å°ç¾ã€é¼»é¼»ï¼‰", cur || "");
    if(nick === null) return;
    setNickname(nick);
    logEvent("set_nickname", { value: nick });
    render();
    toast("å·²è¨­å®šæš±ç¨±");
  }
  document.getElementById("btnSetNick").addEventListener("click", promptNick);

  // ===== Seed demo peers =====
  document.getElementById("btnSeed").addEventListener("click", ()=>{
    const bots = [
      {nickname:"é˜¿é˜¿é¾", exp:40, streak:2},
      {nickname:"å°ç¾", exp:60, streak:3},
      {nickname:"é¼»é¼»å®ˆè­·è€…", exp:20, streak:1}
    ];
    const rows = dbLoad();
    const now = Date.now();
    bots.forEach((b,i)=>{
      const uid = "BOT_" + (i+1);
      rows.push({ts:new Date(now - (i+2)*60000).toISOString(), user_id:uid, nickname:b.nickname, level:1, event:"checkin", exp_change:10, total_exp:b.exp, streak:b.streak});
    });
    dbSave(rows);
    renderLeaderboard();
    toast("å·²åŠ å…¥åŒå„•ï¼ˆDemoï¼‰");
  });

  // ===== Reset =====
  document.getElementById("btnReset").addEventListener("click", ()=>{
    if(!confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿè³‡æ–™ï¼Ÿï¼ˆæœƒæ¸…ç©ºæ’è¡Œæ¦œã€EXPã€æ‰“å¡èˆ‡æ¸¬é©—ç´€éŒ„ï¼‰")) return;
    localStorage.removeItem(DB_KEY);
    localStorage.removeItem(STATE_KEY);
    render();
    startStory();
    document.getElementById("btnContinue").disabled = false;
    toast("å·²æ¸…ç©º");
  });

  // ===== Video task =====
  document.getElementById("btnOpenVideo").addEventListener("click", ()=>{
    const url = document.getElementById("videoUrl").value.trim();
    if(!url){ alert("è«‹å…ˆè²¼ä¸Šå½±ç‰‡é€£çµ"); return; }
    window.open(url, "_blank");
    const s = stateLoad();
    s.videoOpened = true;
    stateSave(s);
    logEvent("video_open", { value:url });
    render();
    toast("å·²è¨˜éŒ„ï¼šé–‹å•Ÿå½±ç‰‡");
  });

  // ===== Quiz =====
  const ANSWERS = { q1:"A", q2:"B", q3:"B" };
  const PASS_SCORE = 2;

  document.getElementById("quizForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const answers = { q1: fd.get("q1"), q2: fd.get("q2"), q3: fd.get("q3") };
    let score = 0;
    for(const k of ["q1","q2","q3"]) if(answers[k] === ANSWERS[k]) score += 1;
    const passed = score >= PASS_SCORE;

    const s = stateLoad();
    s.quizScore = score;
    s.quizAt = new Date().toISOString();
    s.unlocked = passed;
    s.quizText = passed ? `âœ… é€šéï¼ˆ${score}/3ï¼‰å·²è§£é–æ‰“å¡` : `âŒ æœªé€šéï¼ˆ${score}/3ï¼‰è«‹å†è©¦ä¸€æ¬¡`;
    stateSave(s);

    logEvent("quiz_submit", { score, passed: passed ? 1 : 0, answers });
    render();
    toast(passed ? "è§£é–æˆåŠŸ" : "å†è©¦ä¸€æ¬¡");
  });

  // ===== Check-in =====
  document.getElementById("btnCheckin").addEventListener("click", ()=>{
    const s = stateLoad();
    if(!s.unlocked){ alert("éœ€å…ˆé€šéå°æ¸¬é©—æ‰èƒ½æ‰“å¡"); return; }
    if(s.lastCheckin === todayKey()){ alert("ä»Šå¤©å·²æ‰“å¡"); return; }

    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0,10);
    if(s.lastCheckin === yesterday) s.streak = (s.streak||0) + 1;
    else s.streak = 1;

    s.lastCheckin = todayKey();
    s.checkinAt = new Date().toISOString();
    s.exp = (s.exp || 0) + 10;

    // simple level up: every 50 exp +1 lv, hp recover
    const newLv = 1 + Math.floor((s.exp||0)/50);
    if(newLv > (s.lv||1)){
      s.lv = newLv;
      s.hp = Math.min(100, (s.hp||72) + 8);
      toast("å‡ç´šï¼Lv." + newLv);
    }else{
      s.hp = Math.min(100, (s.hp||72) + 3);
    }

    stateSave(s);
    logEvent("checkin", { exp_change: 10, total_exp: s.exp, streak: s.streak });
    render();
    toast("æ‰“å¡ +10 EXP");
  });

  // init
  startStory();
  render();
</script>
</body>
</html>
